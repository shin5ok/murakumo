#!/usr/bin/env perl
use strict;
use warnings;
use LWP::UserAgent;
use HTTP::Request::Common q(POST);
use JSON;
use Text::ASCIITable;
use Getopt::Long;

my $uuid;
GetOptions( "uuid=s" => \$uuid );


my $param_ref = sample_get_param( @ARGV );

print vps_define( data => encode_json $param_ref ), "\n";

sub vps_define {
  my $lwp = LWP::UserAgent->new;
  $lwp->timeout(5);

  my %param    = @_;
  my $url      = 'http://192.168.232.29:3000/vps/define/register/';
  my $request  = POST $url, [ %param ];
  my $response =$lwp->request( $request );

  my $error = "";
  if ($response->is_success) {
    my $content = $response->content;
    no strict 'refs';
    if ( ! $content->{root}->{result} ) {
      return "ok";
    } else {
      $error = $content->{root}->{error};
    }
  }

  my $ng = "NG";
  $error and $ng .= "($error)";
  return $ng;
 
}

sub sample_get_param {

  $uuid ||= `uuidgen`;
  chomp $uuid;
  my ($name, $cpu, $memory, $user_switch, $add_disk)
    = @_;

  my %param = (
    name               => $name,
    uuid               => $uuid,
    cpu_number         => $cpu,
    memory_number      => $memory,
    user_switch_number => $user_switch,
    add_disk_number    => $add_disk,
  );

  return { root => \%param };

}
